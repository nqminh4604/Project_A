<!doctype html>
<html class="no-js" lang="zxx" xmlns:th="http://www.thymeleaf.org">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<head th:replace="~{layout::page_head}"></head>

<body>
<div class="wrapper">
    <header class="header-sticky" th:replace="~{layout::page_header}"></header>
    <!-- Main Header Area End Here -->
    <!-- Breadcrumb Area Start Here -->
    <div class="breadcrumb-area pt-65 pb-70 bg-img" style="background-image:url(assets/img/bg-image/hop-brech-bg.jpg);">
        <div class="container">
            <div class="breadcrumb-wrap text-center">
                <h3>Product Details</h3>
                <ol class="breadcrumb breadcrumb-list">
                    <li class="breadcrumb-item"><a th:href="@{/home}">Home</a></li>
                    <li class="breadcrumb-item active">Product Details</li>
                </ol>
            </div>
        </div>
    </div>
    <!-- Breadcrumb Area End Here -->
    <!-- Product Thumbnail Start -->
    <div class="main-product-thumbnail white-bg pt-90 pb-90">
        <div class="container">
            <div class="row">
                <!-- Main Thumbnail Image Start -->
                <div class="col-lg-5 col-md-6 mb-all-40">
                    <!-- Thumbnail Large Image start -->
                    <div class="tab-content">
                        <div id="thumb1" class="tab-pane fade show active">
                            <a data-fancybox="images" th:href="${product.thumbnail != null ? product.thumbnail.filePath : 'default-image.jpg'}"><img
                                    th:src="${product.thumbnail != null ? product.thumbnail.filePath : 'default-image.jpg'}" alt="product-view"></a>
                        </div>
                        <div th:each="productSlider, iterStat : ${product.getProductSliders()}" th:id="'thumb' + ${iterStat.index + 2}" class="tab-pane fade">
                            <a data-toggle="tab" th:href="'#thumb' + ${iterStat.index + 2}">
                                <img th:src="${productSlider.filePath}" th:alt="${productSlider.alt}">
                            </a>
                        </div>

<!--                        <div id="thumb3" class="tab-pane fade">-->
<!--                            <a data-fancybox="images" href="assets/img/products/p3.jpg"><img-->
<!--                                    src="assets/img/products/p3.jpg" alt="product-view"></a>-->
<!--                        </div>-->
                    </div>
                    <!-- Thumbnail Large Image End -->
                    <!-- Thumbnail Image End -->
                    <div class="product-thumbnail">
                        <div class="thumb-menu owl-carousel nav tabs-area nav-style" role="tablist">
                            <a class="active" data-toggle="tab" href="#thumb1"><img th:src="${product.thumbnail != null ? product.thumbnail.filePath : 'default-image.jpg'}"
                                                                                    alt="product-thumbnail"></a>
                            <a th:each="media, iterStat : ${product.productSliders}"
                               data-toggle="tab"
                               th:href="'#thumb' + ${iterStat.index + 2}">
                                <img th:src="${media.filePath}" th:alt="${media.alt}">
                            </a>
<!--                            <a data-toggle="tab" href="#thumb3"><img src="assets/img/products/p3.jpg"-->
<!--                                                                     alt="product-thumbnail"></a>-->
                        </div>
                    </div>
                    <!-- Thumbnail image end -->
                </div>
                <!-- Main Thumbnail Image End -->
                <!-- Thumbnail Description Start -->
                <div class="col-lg-7 col-md-6">
                    <div class="thubnail-desc fix">
                        <h3 class="product-header" th:text="${product.name}"></h3>
<!--                        <ul class="rating-summary">-->
<!--                            <li class="rating-pro">-->
<!--                                <i class="fa fa-star"></i>-->
<!--                                <i class="fa fa-star"></i>-->
<!--                                <i class="fa fa-star-o"></i>-->
<!--                                <i class="fa fa-star-o"></i>-->
<!--                                <i class="fa fa-star-o"></i>-->
<!--                            </li>-->
<!--                        </ul>-->
                        <div class="pro-price mt-10">
                            <p class="d-flex align-items-center">
<!--                                <span class="prev-price">16.51</span>-->
                                <span class="price" th:text="'$' + ${product.price}"></span>
<!--                                <span class="saving-price">-5%</span></p>-->
                        </div>
                        <p class="pro-desc-details  mb-30" th:text="${product.summary}"></p>
                        <!--                            <div class="product-size mtb-30 clearfix">-->
                        <!--                                <label>Size</label>-->
                        <!--                                <select class="">-->
                        <!--                                    <option>S</option>-->
                        <!--                                    <option>M</option>-->
                        <!--                                    <option>L</option>-->
                        <!--                                </select>-->
                        <!--                            </div>-->
                        <!--                            <div class="color clearfix mb-30">-->
                        <!--                                <label>color</label>-->
                        <!--                                <ul class="color-list">-->
                        <!--                                   <li>-->
                        <!--                                        <a class="white" href="#"></a>-->
                        <!--                                    </li>-->
                        <!--                                    <li>-->
                        <!--                                        <a class="orange active" href="#"></a>-->
                        <!--                                    </li>-->
                        <!--                                    <li>-->
                        <!--                                        <a class="paste" href="#"></a>-->
                        <!--                                    </li>-->
                        <!--                                </ul>-->
                        <!--                            </div>-->
                        <div class="quatity-stock mb-30">
                            <div class="pro-ref mb-30">
                                <p><span class="in-stock" th:text="'In stock:  ' + ${product.inStock}"></span></p>
                            </div>
                            <label>Quantity</label>
                            <ul class="d-flex flex-wrap  align-items-center mt-30">
                                <li class="box-quantity">
                                    <form action="#">
<!--                                        <input class="quantity" type="number" min="1" value="1">-->
                                        <input class="quantity" type="number" min="1" value="1" th:data-stock="${product.inStock}">

                                    </form>

                                </li>
                                <li>
                                    <a href="javascript:void(0);" class="add-to-cart-btn" th:data-id="${product.id}">
                                        <i class="icon-cart"></i>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <div class="social-sharing mt-30">
                            <ul>
                                <li><label>share</label></li>
                                <li><a href="#"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
                                <li><a href="#"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
                                <li><a href="#"><i class="fa fa-google-plus" aria-hidden="true"></i></a></li>
                                <li><a href="#"><i class="fa fa-pinterest-p" aria-hidden="true"></i></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- Thumbnail Description End -->
            </div>
            <!-- Row End -->
        </div>
        <!-- Container End -->
    </div>
    <!-- Product Thumbnail End -->
    <!-- Product Thumbnail Description Start -->
    <div class="thumnail-desc white-bg">
        <div class="container">
            <div class="thumb-desc-inner">
                <div class="row">
                    <div class="col-sm-12">
                        <ul class="main-thumb-desc nav tabs-area" role="tablist">
                            <li><a class="active" data-toggle="tab" href="#dtail">Description</a></li>
<!--                            <li><a data-toggle="tab" href="#review">Reviews 1</a></li>-->
                        </ul>
                        <!-- Product Thumbnail Tab Content Start -->
                        <div class="tab-content thumb-content">
                            <div id="dtail" class="tab-pane fade show active">
                                <p th:utext="${product.description}"></p>
                            </div>
                            <div id="review" class="tab-pane fade">
                                <!-- Reviews Start -->
                                <div class="review">
                                    <div class="group-title">
                                        <h2>customer review</h2>
                                    </div>
                                    <h4 class="review-mini-title">Outstride</h4>
                                    <ul class="review-list">
                                        <!-- Single Review List Start -->
                                        <li>
                                            <span>Quality</span>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star-o"></i>
                                            <i class="fa fa-star-o"></i>
                                            <label>Outstride</label>
                                        </li>
                                        <!-- Single Review List End -->
                                        <!-- Single Review List Start -->
                                        <li>
                                            <span>price</span>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star-o"></i>
                                            <i class="fa fa-star-o"></i>
                                            <i class="fa fa-star-o"></i>
                                            <label>Review by <a href="#">Outstride</a></label>
                                        </li>
                                        <!-- Single Review List End -->
                                        <!-- Single Review List Start -->
                                        <li>
                                            <span>value</span>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star-o"></i>
                                            <label>Posted on 12/20/18</label>
                                        </li>
                                        <!-- Single Review List End -->
                                    </ul>
                                </div>
                                <!-- Reviews End -->
                                <!-- Reviews Start -->
                                <div class="review mt-30">
                                    <h2 class="review-title mb-30">You're reviewing: <br><span>Faded Short Sleeves T-shirt</span>
                                    </h2>
                                    <p class="review-mini-title">your rating</p>
                                    <ul class="review-list">
                                        <!-- Single Review List Start -->
                                        <li>
                                            <span>Quality</span>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star-o"></i>
                                            <i class="fa fa-star-o"></i>
                                        </li>
                                        <!-- Single Review List End -->
                                        <!-- Single Review List Start -->
                                        <li>
                                            <span>price</span>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star-o"></i>
                                            <i class="fa fa-star-o"></i>
                                            <i class="fa fa-star-o"></i>
                                        </li>
                                        <!-- Single Review List End -->
                                        <!-- Single Review List Start -->
                                        <li>
                                            <span>value</span>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star"></i>
                                            <i class="fa fa-star-o"></i>
                                        </li>
                                        <!-- Single Review List End -->
                                    </ul>
                                    <!-- Reviews Field Start -->
                                    <div class="riview-field mt-40">
                                        <form autocomplete="off" action="#">
                                            <div class="form-group">
                                                <label class="req" for="sure-name">Name</label>
                                                <input type="text" class="form-control" id="sure-name"
                                                       required="required">
                                            </div>
                                            <div class="form-group">
                                                <label class="req" for="subject">Title of review</label>
                                                <input type="text" class="form-control" id="subject"
                                                       required="required">
                                            </div>
                                            <div class="form-group">
                                                <label class="req" for="comments">Your Review</label>
                                                <textarea class="form-control" rows="5" id="comments"
                                                          required="required"></textarea>
                                            </div>
                                            <button type="submit" class="customer-btn">Submit</button>
                                        </form>
                                    </div>
                                    <!-- Reviews Field Start -->
                                </div>
                                <!-- Reviews End -->
                            </div>
                        </div>
                        <!-- Product Thumbnail Tab Content End -->
                    </div>
                </div>
                <!-- Row End -->
            </div>
        </div>
        <!-- Container End -->
    </div>
    <!-- Product Thumbnail Description End -->
    <div class="best-seller-area pt-80 pb-90">
        <div class="container">
            <div class="section-title text-center mb-45">
                <h2>Related product</h2>
            </div>
            <div class="best-seller-active owl-carousel">
                <div class="single-aboss-product" th:each="product:${thisCateProducts}">
                    <div class="pro-img">
                        <a th:href="@{/product-details(productId=${product.getId()})}"><img th:src="${product.thumbnail != null ? product.thumbnail.filePath : 'default-image.jpg'}" alt="product-img"></a>
                        <div class="pro-actions">
<!--                            <a data-toggle="modal" data-target="#product-window" class="quick-view" href="#"><i-->
<!--                                    class="icon-search"></i></a>-->
                        </div>
                    </div>
                    <div class="pro-content">
                        <h4 th:text="${product.name}"><a th:href="@{/product-details(productId=${product.getId()})}"></a></h4>
                        <div class="pro-price-cart">
                            <div class="pro-home-price">
                                <span th:text="'$' + ${product.price}"></span>
                            </div>
                            <div class="pro-cart">
<!--                                <a title="Add To Cart" href="#"><i class="icon-cart"></i></a>-->
                                <a  title="Add To Cart" href="javascript:void(0);" class="add-to-cart-btn" th:data-id="${product.id}">
                                    <i class="icon-cart"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer-area bg-img" th:replace="~{layout::page_footer}"></footer>
</div>
<th:block th:replace="layout :: scripts"></th:block>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const checkboxes = document.querySelectorAll(".category-filter");
        const gridView = document.getElementById("grid-view");
        const listView = document.getElementById("list-view");

        // Initialize price range slider
        $("#slider-range").slider({
            range: true,
            min: 0,
            max: 10000,
            values: [0, 10000],
            slide: function (event, ui) {
                $("#amount").val("$" + ui.values[0] + " - $" + ui.values[1]);
            },
            stop: function (event, ui) {
                fetchFilteredProducts();
            }
        });

        $("#amount").val("$" + $("#slider-range").slider("values", 0) +
            " - $" + $("#slider-range").slider("values", 1));

        function fetchFilteredProducts() {
            let selectedCategories = [];
            document.querySelectorAll(".category-filter:checked").forEach((cb) => {
                selectedCategories.push(cb.value);
            });

            let minPrice = $("#slider-range").slider("values", 0);
            let maxPrice = $("#slider-range").slider("values", 1);
            let selectedSortElement = document.querySelector(".option.selected");
            let selectedSort = selectedSortElement ? selectedSortElement.getAttribute("data-value") : "";

            console.log("Fetching products with:", { selectedCategories, minPrice, maxPrice, selectedSort });

            let queryParams = new URLSearchParams();
            if (selectedCategories.length > 0) {
                queryParams.append("categories", selectedCategories.join(","));
            }
            queryParams.append("minPrice", minPrice);
            queryParams.append("maxPrice", maxPrice);
            if (selectedSort) {
                queryParams.append("sort", selectedSort);
            }

            fetch('/filter-products?' + queryParams.toString(), {
                method: 'GET',
                headers: {'Content-Type': 'application/json'}
            })
                .then(response => response.text())
                .then(data => {
                    console.log("Response received, updating UI");
                    document.getElementById("product-container").innerHTML = data;

                    if (gridView.classList.contains("show")) {
                        listView.classList.remove("show", "active");
                        gridView.classList.add("show", "active");
                    } else {
                        gridView.classList.remove("show", "active");
                        listView.classList.add("show", "active");
                    }
                })
                .catch(error => console.error('Error fetching products:', error));
        }

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener("change", fetchFilteredProducts);
        });

        document.getElementById("sort-options").addEventListener("click", function (event) {
            console.log("Sort option clicked:", event.target);

            if (event.target.tagName === "LI") {
                console.log("Clicked on:", event.target.getAttribute("data-value"));

                // Remove 'selected' class from all options
                document.querySelectorAll(".option").forEach(opt => opt.classList.remove("selected"));

                // Add 'selected' class to the clicked option
                event.target.classList.add("selected");

                console.log("Sorting changed to:", event.target.getAttribute("data-value"));

                // Fetch the filtered and sorted products
                fetchFilteredProducts();
            }
        });


    });
</script>
<!-- jquery 3.2.1 -->

<script th:inline="javascript">
    function showToast(message, type = "success") {
        let bgColor = type === "error" ? "#ff4d4d" : "linear-gradient(to right, #00b09b, #96c93d)";
        Toastify({
            text: message,
            duration: 2000,
            close: true,
            gravity: "top",
            position: "center",
            stopOnFocus: true,
            style: {background: bgColor},
        }).showToast();
    }

    $(document).ready(function () {
        $(document).ready(function () {
            // Fetch cart data when page loads
            function fetchCartData() {
                $.ajax({
                    url: "/cart/data",
                    type: "GET",
                    success: function (response) {
                        console.log("success load page");
                        updateCartCount(response.cartSize);
                        updateCartUI(response.cartItems);
                    },
                    error: function () {
                        console.log("Error fetching cart data");
                    }
                });
            }
            fetchCartData();
        });
        // Ensure quantity does not exceed available stock
        $(document).on("input", ".quantity", function () {
            let stock = parseInt($(this).attr("data-stock"), 10) || 0;
            let quantity = parseInt($(this).val(), 10);
            let addToCartBtn = $(this).closest(".quantity-stock").find(".add-to-cart-btn");

            if (isNaN(quantity) || quantity < 1) {
                $(this).val(1);
                addToCartBtn.prop("disabled", false);
                return;
            }

            if (quantity > stock) {
                showToast("You cannot order more than the available stock!", "error");
                $(this).val(stock);
                addToCartBtn.prop("disabled", true);
            } else {
                addToCartBtn.prop("disabled", false);
            }
        });

        // Handle "Add to Cart" click
        $(document).on("click", ".add-to-cart-btn", function () {
            let productId = $(this).attr("data-id");
            let quantityInput = $(this).closest("li").prev(".box-quantity").find(".quantity");
            let stock = parseInt(quantityInput.attr("data-stock"), 10) || 0;
            let quantity = parseInt(quantityInput.val(), 10);
            console.log("quantity: " + quantity);
            if (quantity > stock) {
                showToast("Cannot add more than available stock!", "error");
                return;
            }

            // Send quantity to backend
            $.ajax({
                type: "POST",
                url: "/cart/add",
                contentType: "application/json",
                data: JSON.stringify({id: productId, quantity: quantity}),
                success: function (response) {
                    updateCartCount(response.cartSize);
                    updateCartUI(response.cartItems);
                    showToast("Product added to cart!");
                },
                error: function () {
                    showToast("Error adding product to cart!", "error");
                }
            });
        });

        function updateCartCount(count) {
            $("#toi-muon-count").text(count);
        }

        function updateCartUI(cartItems) {
            let cartContainer = $(".ht-dropdown-cart");
            cartContainer.empty();
            let totalPrice = 0;

            if (cartItems.length === 0) {
                cartContainer.append('<li class="text-center">Your cart is empty</li>');
                return;
            }

            cartItems.forEach((item) => {
                let cartHtml = `
                <li class="single-cart-box">
                    <div class="cart-img">
                        <a href="#"><img src="${item.thumbNail}" alt="cart-image"></a>
                        <span class="pro-quantity">${item.quantity}</span>
                    </div>
                    <div class="cart-content">
                        <h6><a href="/product-details">${item.productName}</a></h6>
                        <span class="cart-price">$ ${item.price}</span>
                    </div>
                    <a class="del-icon remove-item" data-id="${item.id}"><i class="ion-close"></i></a>
                </li>
                `;
                cartContainer.append(cartHtml);
                totalPrice += parseFloat(item.price) * item.quantity;
            });

            let footer = `
            <li class="cart-footer">
                <ul class="price-content">
                    <li>Total <span>$ ${totalPrice.toFixed(2)}</span></li>
                </ul>
                <div class="cart-actions text-center">
                    <a class="cart-checkout" id="view-cart-btn">View Cart</a>
                </div>
            </li>
            `;
            cartContainer.append(footer);
        }

        // Handle "View Cart" button click
        $(document).on("click", "#view-cart-btn", function () {
            window.location.href = "/cart";
        });

        // Handle Remove Item from Cart
        $(document).on("click", ".remove-item", function (e) {
            e.preventDefault();
            let productId = $(this).attr("data-id");

            $.ajax({
                type: "POST",
                url: "/cart/remove",
                contentType: "application/json",
                data: JSON.stringify({id: productId}),
                success: function (response) {
                    updateCartCount(response.cartSize);
                    updateCartUI(response.cartItems);
                    showToast("Item removed from cart!", "success");
                },
                error: function () {
                    showToast("Error removing item!", "error");
                }
            });
        });
    });
</script>


</body>
</html>